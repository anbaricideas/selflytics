{# Garmin link form fragment - used for HTMX partial updates #}
<form
    data-testid="form-link-garmin"
    hx-post="/garmin/link"
    hx-swap="outerHTML"
    x-data="{ loading: false }"
    @submit="loading = true"
    data-reset-loading-on-swap
    class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm space-y-4"
>
    {# CSRF Token (MUST be first field) #}
    <input type="hidden" name="fastapi-csrf-token" value="{{ csrf_token }}">

    {% if error_message %}
    <!-- Error message -->
    <div class="bg-red-50 border border-red-200 rounded-lg p-4" data-testid="error-message">
        <p class="text-red-800 font-semibold">{{ error_title or "Failed to link Garmin account" }}</p>
        <p class="text-sm text-red-600 mt-2">{{ error_message }}</p>
    </div>
    {% endif %}

    <h2 class="text-xl font-semibold text-gray-900 mb-4">Link Your Garmin Account</h2>
    <p class="text-gray-600 mb-6">
        Connect your Garmin account to enable AI-powered analysis of your fitness data.
    </p>

    <div>
        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">
            Garmin Email
        </label>
        <input
            data-testid="input-garmin-username"
            type="email"
            id="username"
            name="username"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="your.email@example.com"
        >
    </div>

    <div>
        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">
            Garmin Password
        </label>
        <input
            data-testid="input-garmin-password"
            type="password"
            id="password"
            name="password"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            placeholder="••••••••"
        >
    </div>

    <button
        data-testid="submit-link-garmin"
        type="submit"
        :disabled="loading"
        class="w-full flex justify-center items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
    >
        <span x-show="!loading">Link Account</span>
        <span x-show="loading" x-cloak class="flex items-center">
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Linking...
        </span>
    </button>

    <div class="p-4 bg-blue-50 rounded-md">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <p class="text-xs text-blue-800">
                    <strong>Privacy & Security:</strong> Your credentials are encrypted and stored securely using Google Cloud KMS.
                    We never share your data with third parties. If your Garmin account has MFA enabled, you may be prompted for verification.
                </p>
            </div>
        </div>
    </div>
</form>
